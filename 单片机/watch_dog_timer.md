# 看门狗

[TOC]

## 简介

看门狗是一个计数器，当看门狗中的数字超过设定值，就会判定为程序异常，强制复位整个系统。防止死循环或者程序跑飞。

## 工作原理

### 硬件

看门狗在硬件方面是一个计数器，系统启动以后，该计数器会被设置一个数字，然后递减/递增，直到超过限制，复位器件（reset信号）。常用的WDT芯片如MAX813 ,5045, IMP 813等，目前也有集成在芯片中的看门狗。

### 软件

软件方面有责任经常将计数器的数值重置，如果未能及时重置，则表示发生某种故障，需要进行系统重置。

### 休眠状态

当器件处于正常状态时，看门狗超时会使器件复位。

但当器件（cpu）为休眠或者空闲状态时，看门狗的超时会使器件唤醒，使其正常操作

## 功能应用

栈或堆溢出，程序跑飞

某段程序异常无法返回或陷入死循环

强电磁干扰破坏数据导致系统异常，

bug导致的系统宕机，或者死循环

多任务系统中死锁

## 常见的处理策略

系统复位

失效安全，也叫fail-safe 模式。就是设备即使出现致命故障了，也别造成安全事故。举个例子，一个正在下降的电梯，加入看门狗检测到程序异常了，安全的做法是赶紧停止电机转动，否则自由落体。这在IEC61508 功能安全标准，或者医疗安全标准、汽车安全标准中都有体现。

也可以在芯片复位后，使用芯片的复位状态寄存器，对看门狗复位事件进行计数，当数值大于设定的数值之后，将系统切换到安全状态或显示错误信息，防止无限期重启。

## 怎样喂狗/复位

### 单片机裸机

一、故障检测型

在喂狗的同时，进行关键运行的检测，比如栈深度、缓冲区、关键功能链的硬件（如传感器、执行机构等）,如这些状态异常，则记录错误状态，将设备至于功能安全状态。![img](图片/watch_dog_timer.assets/v2-7adc67f4bb729d3c160622166ad1c4bc_b.jpg)

二、序列检测式喂狗

将主函数的主体关键功能块，设置序列标记，如果出现错误就将标记置位，最终所有的标记都没有置位时才进行喂狗。![img](图片/watch_dog_timer.assets/v2-dbfa6d741a81d04db5e46279443738f8_b.jpg)

### 多任务实时系统

需求：
检测操作系统是否正确运行
在所有任务中检测是否有死循环
检测涉及两个或多个任务的死锁
检测由于高优先级任务占用CPU而导致某些低优先级任务无法运行![img](图片/watch_dog_timer.assets/v2-80c2ad6207f4baefb9ffeb14fec3e025_b.jpg)

watchdog_Taskmonitor可看成总线程（狗窝），里面管理一堆狗，其中总线程中的硬件看门狗是母狗，软件子任务（task1，task2、、、）看门狗为小狗仔。每个子任务需要在每一个loop循环喂一次狗，当然实际实现时也可以加入任务故障检测式喂狗（也可以理解为一个标签，传给总线程），在watchdog_Taskmonitor每一个循环都对所有软件看门狗递减，如果溢出则软狗叫了，需要做异常处理（复位或进入失效安全模式）。**如果所有的软件狗都没有溢出（返回了正常的标签），则喂硬件看门狗**（可能是单片机内置或外置芯片）

实际实现时须注意：
		watchdog_Taskmonitor应选取最高优先级
		每个loop应调用os_delay一定时间，以出让CPU时间给其他task运行。挂起的时间应小于最大硬件看门狗延时时间。
		须合理安排各任务的优先级
		不要在中断以及其他函数中私自喂狗

## 参考

[知乎](单片机编程：如何喂狗的灵魂拷问 - 逸珺的文章 - 知乎 https://zhuanlan.zhihu.com/p/147934002)

[csdn-硬件看门狗和软件看门狗](https://blog.csdn.net/jiangganwu/article/details/80502198?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522162391330416780262597787%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=162391330416780262597787&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~sobaiduend~default-1-80502198.nonecase&utm_term=%E8%BD%AF%E4%BB%B6%E7%9C%8B%E9%97%A8%E7%8B%97&spm=1018.2226.3001.4450)

[百度百科-看门狗](https://baike.baidu.com/item/%E7%9C%8B%E9%97%A8%E7%8B%97%E5%AE%9A%E6%97%B6%E5%99%A8)

