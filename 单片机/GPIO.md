# GPIO

[TOC]

## 一、简介

GPIO（General-purpose input/output）通用型之输入输出的简称，接脚可以供[使用者](https://baike.baidu.com/item/使用者/1162412)由程控自由使用，PIN脚依现实考量可作为通用输入（*GPI*）或通用输出（*GPO*）或通用输入与输出（*GPIO*），如当clk generator, chip select等。

对于输入，一定可以通过读取某个寄存器来确定引脚电位的高低；对于输出，一定可以通过写入某个寄存器来让这个引脚输出高电位或者低电位；对于其他特殊功能，则有另外的寄存器来控制它们。

## 二、结构框图

![img](图片/GPIO.assets/v2-fdc247bab1c8d9607ad86ae5cfce30da_b.jpg)

此框图中只有最右端的I/O pin是板上外露可见的，其他部分均在芯片内部。该框图结构被分为两个部分，其一是输出结构，主要由引脚（I/O pin）、保护二极管（protection diode）、双MOS管(P-MOS+N-MOS)、输出控制(output control)、输出数据寄存器(output data register)、位置位/复位寄存器(bit set/reset register)组成 ；其二是输入结构，由引脚、保护二极管、双开关(on/off)、TTL肖特基触发器(TTL Schmitt trigger)、输入数据寄存器(input data register)组成。[来源](https://zhuanlan.zhihu.com/p/130375106)

![img](图片/GPIO.assets/v2-bd05d41918b7609ab31f275c535e046a_b.jpg)

## 三、功能

4种输入模式：
GPIO_Mode_AIN      模拟输入

GPIO_Mode_IN_FLOATING      浮空输入

GPIO_Mode_IPD     下拉输入

GPIO_Mode_IPU     上拉输入

4种输出模式：
GPIO_Mode_Out_OD 开漏输出

GPIO_Mode_Out_PP 推挽输出

GPIO_Mode_AF_OD 复用开漏输出

GPIO_Mode_AF_PP 复用推挽输出

### 1、输入

#### 浮空输入模式

**浮空输入模式下，I/O端口的电平信号直接进入输入数据寄存器。也就是说，I/O的电平状态是不确定的，完全由外部输入决定；如果在该引脚悬空（在无信号输入）的情况下，读取该端口的电平是不确定的。**

![img](图片/GPIO.assets/2018040822505125)

#### 上拉输入模式

**上拉输入模式下，I/O端口的电平信号直接进入输入数据寄存器。但是在I/O端口悬空（在无信号输入）的情况下，输入端的电平可以保持在高电平；并且在I/O端口输入为低电平的时候，输入端的电平也还是低电平。**

![img](图片/GPIO.assets/20180408225353767)

#### 下拉输入模式

**下拉输入模式下，I/O端口的电平信号直接进入输入数据寄存器。但是在I/O端口悬空（在无信号输入）的情况下，输入端的电平可以保持在低电平；并且在I/O端口输入为高电平的时候，输入端的电平也还是高电平。**

![img](图片/GPIO.assets/20180408225847140)

#### 模拟输入模式

模拟输入模式下，I/O端口的模拟信号（电压信号，而非电平信号）直接模拟输入到片上外设模块，比如ADC模块等等。

![img](图片/GPIO.assets/20180409125151818)

### 2、输出

#### 开漏输出模式

开漏输出模式下，通过设置**位设置/清除寄存器或者输出数据寄存器**的值，途经N-MOS管，最终输出到I/O端口。

这里要注意N-MOS管，当设置输出的值为高电平的时候，N-MOS管处于关闭状态，**此时I/O端口的电平就不会由输出的高低电平决定，而是由I/O端口外部的上拉或者下拉决定**；
当设置输出的值为低电平的时候，N-MOS管处于开启状态，此时I/O端口的电平就是低电平。

同时，I/O端口的电平也可以通过输入电路进行读取；

**注意，I/O端口的电平不一定是输出的电平。**

![img](图片/GPIO.assets/2018040912560259)

#### 开漏复用输出模式

开漏复用输出模式，与开漏输出模式很是类似。

只是输出的高低电平的来源，不是让CPU直接写输出数据寄存器，取而代之**利用片上外设模块的复用功能输出来决定的**。

![img](图片/GPIO.assets/201804091309492)

#### 推挽输出模式

推挽输出模式下，通过**设置位设置/清除寄存器**或者**输出数据寄存器**的值，途经P-MOS管和N-MOS管，最终输出到I/O端口。

这里要注意P-MOS管和N-MOS管，当设置输出的值为高电平的时候，P-MOS管处于开启状态，N-MOS管处于关闭状态，此时I/O端口的电平就由P-MOS管决定：高电平；
当设置输出的值为低电平的时候，P-MOS管处于关闭状态，N-MOS管处于开启状态，此时I/O端口的电平就由N-MOS管决定：低电平。

同时，I/O端口的电平也可以通过输入电路进行读取；

注意，**此时I/O端口的电平一定是输出的电平**。**（和开漏输出模式不同）**

![img](图片/GPIO.assets/20180409131225598)

#### 推挽复用输出模式

推挽复用输出模式，与推挽输出模式很是类似。

只是输出的高低电平的来源，不是让CPU直接写输出数据寄存器，取而代之**利用片上外设模块的复用功能输出来决定的。**

![img](图片/GPIO.assets/20180409131625100-1624242715170)

### 3、推挽结构和推挽电路

**推挽结构**一般是指两个参数相同的三极管或MOS管分别受两互补信号的控制，总是在一个三极管或MOS管导通的时候另一个截止。高低电平由输出电平决定。

**推挽电路**是两个参数相同的三极管或MOSFET，以推挽方式存在于电路中，各负责正负半周的波形放大任务。电路工作时，两只对称的功率开关管每次只有一个导通，所以导通损耗小、效率高。输出既可以向负载灌电流，也可以从负载抽取电流。推拉式输出级既提高电路的负载能力，又提高开关速度。

### 4、开漏输出和推挽输出

    开漏输出：只可以输出强低电平，高电平得靠外部电阻拉高。输出端相当于三极管的集电极。适合于做电流型的驱动，其吸收电流的能力相对强(一般20ma以内)；
    推挽输出:可以输出强高、低电平，连接数字器件。

关于推挽输出和开漏输出，最后用一幅最简单的图形来概括：
![img](图片/GPIO.assets/20180409133536882)

该图中左边的便是推挽输出模式，其中比较器输出高电平时下面的PNP三极管截止，而上面NPN三极管导通，输出电平VS+；当比较器输出低电平时则恰恰相反，PNP三极管导通，输出和地相连，为低电平。

右边的则可以理解为开漏输出形式，需要接上拉。

### 5、怎样选择I/O模式

    浮空输入_IN_FLOATING ——浮空输入，可以做KEY识别，RX1
    带上拉输入_IPU——IO内部上拉电阻输入
    带下拉输入_IPD—— IO内部下拉电阻输入
    模拟输入_AIN ——应用ADC模拟输入，或者低功耗下省电
    
    开漏输出_OUT_OD ——IO输出0接GND，IO输出1，悬空，需要外接上拉电阻，才能实现输出高电平。当输出为1时，IO口的状态由上拉电阻拉高电平，但由于是开漏输出模式，这样IO口也就可以由外部电路改变为低电平或不变。可以读IO输入电平变化，实现C51的IO双向功能
    推挽输出_OUT_PP ——IO输出0-接GND， IO输出1 -接VCC，读输入值是未知的
    复用功能的推挽输出_AF_PP ——片内外设功能（I2C的SCL、SDA）
    复用功能的开漏输出_AF_OD——片内外设功能（TX1、MOSI、MISO.SCK.SS）
## 四、相关问题

Q：GPIO口可以直接跑各种的协议，比如说是spi这些的，是他的片上继承了这些协议的硬件电路，还是说是gpio能用软件来模拟这些东西

Q：可以模拟那些串口协议，差分和ttl应该都可以模拟

Q：差分信号可以吗，还是只能ttl电平的（除了ttl还有个啥来着）

Q：硬件I2C和软件I2C
硬件的东西包含了哪些，驱动电路时是什么，最终还是要接到芯片的gpio上吗
其他协议是不是也都有相应硬件电路和驱动

Q：datesheet中一个gpio口可以有多种用途，集成了其他协议的接口，为什么能适应哪么多不同的协议，整合了不同协议的驱动电路
还是说是用软件和gpio来模拟的





















































